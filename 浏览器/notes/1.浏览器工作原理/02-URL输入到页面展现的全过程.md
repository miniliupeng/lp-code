# 02-URL输入到页面展现的全过程

## 1. 用户输入处理

故事始于用户在浏览器地址栏输入内容。

*   **解析输入**：浏览器进程中的 UI 线程首先会判断用户输入的是一个**搜索查询**还是一个合法的 **URL**。
    *   如果是搜索查询，浏览器会使用默认的搜索引擎，并附带上查询关键字，将其拼接成一个新的 URL。
    *   如果是合法的 URL，浏览器会准备开始网络请求。

*   **`beforeunload` 事件**：在当前页面即将被导航离开时，浏览器会触发 `beforeunload` 事件，允许页面在关闭前执行一些清理工作或向用户弹出确认提示。

## 2. 网络请求阶段

在浏览器进程确认了目标 URL 后，会通过其内部的网络线程发起真正的网络请求。

1.  **查找缓存**：
    *   浏览器会首先检查**强缓存**（HTTP Headers 中的 `Expires` 和 `Cache-Control`）。如果资源在缓存中且未过期，就直接从本地缓存中读取，网络请求结束。这是最快的方式。
    *   如果强缓存失效，浏览器会继续检查**协商缓存**（HTTP Headers 中的 `Last-Modified`/`If-Modified-Since` 和 `ETag`/`If-None-Match`）。浏览器会向服务器发送一个请求，服务器根据这些头信息判断资源是否有更新。
        *   若无更新，服务器返回 `304 Not Modified` 响应，浏览器从缓存中加载资源。
        *   若有更新，服务器返回 `200 OK` 和最新的资源。

2.  **DNS 解析 (域名系统)**：
    *   如果缓存中没有，浏览器需要将 URL 中的域名（例如 `www.google.com`）解析成服务器的 IP 地址。
    *   解析顺序如下：
        *   **浏览器 DNS 缓存**：检查浏览器自身是否缓存了该域名的 IP。
        *   **操作系统 DNS 缓存**：检查操作系统（如 Windows 的 `hosts` 文件）是否有缓存。
        *   **路由器 DNS 缓存**：检查路由器的缓存。
        *   **ISP (网络服务提供商) DNS 服务器**：向网络运营商的 DNS 服务器发起请求。
        *   **根 DNS 服务器**：如果以上都没有，请求会逐级向上，从根服务器开始，进行递归或迭代查询，直到找到目标 IP 地址。

3.  **建立 TCP 连接**：
    *   拿到了服务器 IP 地址后，浏览器会通过网络线程与服务器建立一个 TCP 连接。这个过程就是著名的“**三次握手**”：
        *   **第一次握手**：客户端发送一个 `SYN` 包到服务器，请求建立连接。
        *   **第二次握手**：服务器收到 `SYN` 包后，返回一个 `SYN+ACK` 包，表示同意建立连接。
        *   **第三次握手**：客户端收到服务器的确认后，再发送一个 `ACK` 包，连接建立成功。

4.  **发起 HTTP/HTTPS 请求**：
    *   TCP 连接建立后，浏览器就可以向服务器发送 HTTP 请求了。请求中包含了请求行、请求头（如 `Cookie`, `User-Agent` 等）和请求体（如 POST 方法提交的表单数据）。
    *   如果 URL 是 `https` 协议，还需要在 TCP 连接之上建立一个 TLS/SSL 安全层，进行加密通信。这个过程会涉及证书验证和密钥交换。

## 3. 服务器处理与响应

服务器（如 Nginx, Apache）接收到 HTTP 请求后，会进行处理：

*   解析请求，理解客户端的需求。
*   可能需要查询数据库、调用后端服务、读取文件等。
*   构建 HTTP 响应，其中包含状态码（如 `200 OK`, `404 Not Found`）、响应头（如 `Content-Type`, `Set-Cookie`）和响应体（通常是 HTML 内容）。
*   将响应通过 TCP 连接发送回浏览器。

## 4. 浏览器解析与渲染

浏览器进程的网络线程接收到服务器的响应后，会进行解析。

1.  **解析响应头**：网络线程会先查看响应头中的 `Content-Type`。如果是 `text/html`，浏览器就会通知渲染进程准备开始解析和渲染页面。如果是 `application/octet-stream` 等需要下载的类型，则会交给下载管理器。

2.  **提交导航**：浏览器进程将网络请求获取到的数据通过 IPC (进程间通信) 传递给对应的**渲染进程**。

3.  **渲染进程开始工作**：渲染进程的主线程（UI 渲染线程）接收到数据后，开始执行**关键渲染路径 (Critical Rendering Path)** 的流程：

    *   **构建 DOM 树**：解析 HTML 文本，生成一个树状结构的 DOM (Document Object Model)。
    *   **构建 CSSOM 树**：解析 CSS 文件和 `<style>` 标签，生成一个树状结构的 CSSOM (CSS Object Model)，它包含了所有节点的样式信息。
    *   **执行 JavaScript**：当解析器遇到 `<script>` 标签时，DOM 构建会暂停（除非脚本是 `async` 或 `defer` 的），**JS 引擎线程**会接管控制权，开始执行脚本。JS 可能会通过 `document.write` 或 `DOM API` 来修改 DOM 结构。
    *   **构建渲染树 (Render Tree)**：将 DOM 树和 CSSOM 树结合起来，生成渲染树。渲染树只包含需要被渲染的节点（例如，`display: none` 的节点不会出现在渲染树中）。
    *   **布局 (Layout / Reflow)**：根据渲染树，计算出每个节点在屏幕上的精确位置和大小。这个过程也被称为“回流”或“重排”。
    *   **绘制 (Paint)**：根据布局阶段计算出的信息，将每个节点绘制成像素。这个过程会生成一系列的绘制指令。
    *   **合成 (Composite)**：浏览器会将页面的不同部分（特别是那些会被 CSS transform/opacity 影响的部分）提升到独立的图层（Layers）上。最后，**GPU 进程**会将这些图层按照正确的顺序合成，并最终显示在屏幕上。

## 5. 连接关闭

页面完全加载后，TCP 连接可能会被关闭（通过“**四次挥手**”），也可能会根据 HTTP 的 `Keep-Alive` 机制保持连接，以便于后续的请求复用。
